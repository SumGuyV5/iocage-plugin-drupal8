#!/bin/sh

set_sslkey()
{
  shift
  key=$@
  if [ $? -eq 0 ] && [ "$key" != "" ] ; then
    echo "Changing /usr/local/etc/apache24/ssl/private.key..."
    echo "$key" > /usr/local/etc/apache24/ssl/private.key
  else
    echo "Error when updateing /usr/local/etc/apache24/ssl/private.key">2 ; exit 1
  fi
  exit 0
}

set_sslcert()
{
  shift
  cert=$@
  if [ $? -eq 0 ] && [ "$cert" != "" ] ; then
    echo "Changing /usr/local/etc/apache24/ssl/certificate.crt..."
    echo "$cert" > /usr/local/etc/apache24/ssl/certificate.crt
  else
    echo "Error when updateing /usr/local/etc/apache24/ssl/certificate.crt">2 ; exit 1
  fi
  exit 0
}

set_drupaltrust()
{
  shift
  #strip out newlines and replace them with @ @
echo "$@"
  input=$(echo "$@" | sed -e ':a' -e 'N' -e '$!ba' -e 's/\n/@ @/g')
echo "$input"
  #find the trusted_host_patterns Array, remove the old data and put the new data from input in.
  if [ $? -eq 0 ] && [ "$input" != "" ] ; then
    echo "Changing /usr/local/www/drupal8/sites/default/settings.php..."
    sed -i.bak '/\$settings\['\''trusted_host_patterns'\''] = \[/,/];/{ :q
    N
    $!bq
    s/.*/\$settings\['\''trusted_host_patterns'\''] = \[\
  '"$input"'\
];/g;}' /usr/local/www/drupal8/sites/default/settings.php
    #we need to add \ to the . because they did not get transferred with the above sed command
    sed -i.bak '/\$settings\['\''trusted_host_patterns'\''] = \[/,/];/{s/\./\\\./g;}' /usr/local/www/drupal8/sites/default/settings.php
    #we need to change the @ @ back to newlines
    sed -i.bak '/\$settings\['\''trusted_host_patterns'\''] = \[/,/];/{s/@ @/\
/g;}' /usr/local/www/drupal8/sites/default/settings.php
  else
    echo "Error when updateing /usr/local/www/drupal8/sites/default/settings.php">2 ; exit 1
  fi
  exit 0
}

set_apacheconf()
{
  shift
  apacheconf=$@
  if [ $? -eq 0 ] && [ "$apacheconf" != "" ] ; then
    echo "Changing /usr/local/etc/apache24/Includes/drupal.conf..."
    echo "$apacheconf" > /usr/local/etc/apache24/Includes/drupal.conf
  else
    echo "Error when updateing /usr/local/etc/apache24/Includes/drupal.conf">2 ; exit 1
  fi
  exit 0
}

set_adminpasswd()
{
  PASSWD=$1
  if [ $? -eq 0 ] && [ $PASSWD != "" ] ; then
    echo "Changing Drupal Admin password..."
    drush user-password admin --password="$PASSWD" -r /usr/local/www/drupal8
  else
    echo "Error when updateing Drupal 8 admin password.">2 ; exit 1
  fi
  exit 0
}


# Stub for something which sets quasselsettings
echo "$@"
case $1 in
	sslkey) set_sslkey "$@" ;;
	sslcert) set_sslcert "$@" ;;
	drupaltrust) set_drupaltrust "$@" ;;
	apacheconf) set_apacheconf "$@" ;;
  adminpasswd) set_adminpasswd "$2" ;;
	*) echo "Unknown option" ;;
esac
